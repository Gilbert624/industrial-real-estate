"""
è½»é‡çº§é¡¹ç›®ç”˜ç‰¹å›¾ç”Ÿæˆå™¨
ç”¨äºå·¥ä¸šåœ°äº§é¡¹ç›®çš„æ—¶é—´è½´ç®¡ç†å’Œå¯è§†åŒ–
"""

import streamlit as st
import plotly.figure_factory as ff
import plotly.graph_objects as go
import plotly.express as px
import pandas as pd
from datetime import datetime, timedelta
import sqlite3

st.set_page_config(page_title="Project Gantt Chart", page_icon="ğŸ“Š", layout="wide")

# ========== è¾…åŠ©å‡½æ•° ==========

def add_business_days(start_date, days):
    """æ·»åŠ å·¥ä½œæ—¥ï¼ˆè·³è¿‡å‘¨æœ«ï¼‰"""
    current = start_date
    added = 0
    
    while added < days:
        current += timedelta(days=1)
        if current.weekday() < 5:  # 0-4 æ˜¯å‘¨ä¸€åˆ°å‘¨äº”
            added += 1
    
    return current

def parse_natural_language(text):
    """
    è§£æè‡ªç„¶è¯­è¨€è¾“å…¥çš„ä»»åŠ¡
    ä¾‹å¦‚: "DA submission 2å‘¨ï¼Œç°åœ¨å¼€å§‹"
    """
    # ç®€åŒ–ç‰ˆæœ¬ï¼Œå®é™…å¯ä»¥ç”¨Claude APIåšæ›´æ™ºèƒ½çš„è§£æ
    tasks = []
    lines = text.strip().split('\n')
    
    for line in lines:
        if '-' in line:
            name = line.split('-')[1].strip()
            # æå–æŒç»­æ—¶é—´ï¼ˆç®€åŒ–é€»è¾‘ï¼‰
            if 'å‘¨' in name:
                duration = int(name.split('å‘¨')[0].split()[-1]) * 7
                name = name.split('éœ€è¦')[0].strip()
            else:
                duration = 7  # é»˜è®¤1å‘¨
            
            tasks.append({
                'name': name,
                'duration': duration,
                'start': datetime.now()
            })
    
    return tasks

DB_PATH = "industrial_property.db"

def ensure_project_tables(conn):
    """ç¡®ä¿é¡¹ç›®ç›¸å…³è¡¨å­˜åœ¨"""
    conn.execute("""
        CREATE TABLE IF NOT EXISTS assets (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL
        )
    """)
    conn.execute("""
        CREATE TABLE IF NOT EXISTS projects (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            asset_id INTEGER,
            project_name TEXT NOT NULL,
            status TEXT,
            planned_start_date DATE,
            actual_start_date DATE,
            planned_completion_date DATE,
            actual_completion_date DATE,
            created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (asset_id) REFERENCES assets(id)
        )
    """)
    conn.commit()

def seed_sample_projects(conn):
    """å½“é¡¹ç›®ä¸ºç©ºæ—¶å†™å…¥ç¤ºä¾‹æ•°æ®"""
    count = conn.execute("SELECT COUNT(*) FROM projects").fetchone()[0]
    if count > 0:
        return

    assets = [
        ("Sydney Logistics Park",),
        ("Melbourne Industrial Hub",),
        ("Brisbane Cold Storage",),
    ]
    conn.executemany("INSERT INTO assets (name) VALUES (?)", assets)

    asset_ids = [row[0] for row in conn.execute("SELECT id FROM assets ORDER BY id").fetchall()]
    today = datetime.now().date()

    sample_projects = [
        (asset_ids[0], "DA Preparation", "DA", today - timedelta(days=20), None, today + timedelta(days=60), None),
        (asset_ids[1], "Warehouse Expansion", "Planning", today - timedelta(days=5), None, today + timedelta(days=120), None),
        (asset_ids[2], "Cold Chain Upgrade", "Construction", today - timedelta(days=45), today - timedelta(days=30), today + timedelta(days=150), None),
    ]
    conn.executemany(
        """
        INSERT INTO projects (
            asset_id, project_name, status,
            planned_start_date, actual_start_date,
            planned_completion_date, actual_completion_date
        ) VALUES (?, ?, ?, ?, ?, ?, ?)
        """,
        sample_projects
    )
    conn.commit()

def get_projects_from_db():
    """ä»æ•°æ®åº“è·å–é¡¹ç›®ä¿¡æ¯"""
    conn = sqlite3.connect(DB_PATH)
    ensure_project_tables(conn)
    seed_sample_projects(conn)

    query = """
        SELECT 
            p.project_name,
            COALESCE(p.status, 'Planning') AS status,
            COALESCE(p.actual_start_date, p.planned_start_date) AS start_date,
            COALESCE(p.actual_completion_date, p.planned_completion_date) AS expected_completion,
            a.name AS asset_name
        FROM projects p
        LEFT JOIN assets a ON p.asset_id = a.id
        WHERE COALESCE(p.actual_start_date, p.planned_start_date) IS NOT NULL
          AND COALESCE(p.actual_completion_date, p.planned_completion_date) IS NOT NULL
        ORDER BY start_date
    """

    df = pd.read_sql(query, conn)
    conn.close()

    if df.empty:
        return df

    df["start_date"] = pd.to_datetime(df["start_date"])
    df["expected_completion"] = pd.to_datetime(df["expected_completion"])
    df["asset_name"] = df["asset_name"].fillna("æœªå…³è”èµ„äº§")

    today = pd.Timestamp.now().normalize()
    def calc_completion(row):
        if pd.isna(row["start_date"]) or pd.isna(row["expected_completion"]):
            return 0.0
        if row["expected_completion"] <= today:
            return 100.0
        total_days = (row["expected_completion"] - row["start_date"]).days
        if total_days <= 0:
            return 0.0
        elapsed_days = (today - row["start_date"]).days
        return max(0.0, min(100.0, (elapsed_days / total_days) * 100))

    df["completion_percentage"] = df.apply(calc_completion, axis=1)
    return df

# ========== ä¸»ç•Œé¢ ==========

st.title("ğŸ“Š é¡¹ç›®ç”˜ç‰¹å›¾ç”Ÿæˆå™¨")
st.caption("è½»é‡çº§çš„é¡¹ç›®æ—¶é—´è½´ç®¡ç†å·¥å…·")

# é€‰æ‹©è§†å›¾æ¨¡å¼
view_mode = st.radio(
    "é€‰æ‹©è§†å›¾:",
    ["å•ä¸ªé¡¹ç›®è¯¦ç»†è§†å›¾", "å¤šé¡¹ç›®æ€»è§ˆ", "åˆ›å»ºæ–°æ—¶é—´è½´"],
    horizontal=True
)

# ========== å•é¡¹ç›®è¯¦ç»†è§†å›¾ ==========
if view_mode == "å•ä¸ªé¡¹ç›®è¯¦ç»†è§†å›¾":
    
    # ä»æ•°æ®åº“åŠ è½½é¡¹ç›®
    projects_df = get_projects_from_db()
    
    if not projects_df.empty:
        selected_project = st.selectbox(
            "é€‰æ‹©é¡¹ç›®:",
            projects_df['project_name'].tolist()
        )
        
        # è·å–é¡¹ç›®è¯¦æƒ…
        project = projects_df[projects_df['project_name'] == selected_project].iloc[0]
        
        # æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯
        col1, col2, col3, col4 = st.columns(4)
        with col1:
            st.metric("å½“å‰é˜¶æ®µ", project['status'])
        with col2:
            st.metric("è¿›åº¦", f"{project['completion_percentage']:.1f}%")
        with col3:
            start_label = project["start_date"].strftime("%Y-%m-%d")
            st.metric("å¼€å§‹æ—¥æœŸ", start_label)
        with col4:
            completion_label = project["expected_completion"].strftime("%Y-%m-%d")
            st.metric("é¢„è®¡å®Œæˆ", completion_label)
        
        st.divider()
        
        # å®šä¹‰é¡¹ç›®é˜¶æ®µ
        # è¿™é‡Œå¯ä»¥ä»æ•°æ®åº“åŠ è½½ï¼Œæˆ–è€…è®©ç”¨æˆ·è‡ªå®šä¹‰
        stages = [
            {"Task": "Land Acquisition", "Start": "2024-01-01", "Finish": "2024-03-31", "Resource": "Legal"},
            {"Task": "DA Preparation", "Start": "2024-02-01", "Finish": "2024-05-31", "Resource": "Consultant"},
            {"Task": "DA Submission", "Start": "2024-06-01", "Finish": "2024-06-15", "Resource": "Council"},
            {"Task": "Council Approval", "Start": "2024-06-15", "Finish": "2024-10-31", "Resource": "Council"},
            {"Task": "Detailed Design", "Start": "2024-11-01", "Finish": "2024-12-31", "Resource": "Architect"},
            {"Task": "Tendering", "Start": "2025-01-01", "Finish": "2025-02-15", "Resource": "Procurement"},
            {"Task": "Construction", "Start": "2025-03-01", "Finish": "2026-03-31", "Resource": "Builder"},
            {"Task": "Marketing", "Start": "2025-09-01", "Finish": "2026-06-30", "Resource": "Marketing"},
        ]
        
        df = pd.DataFrame(stages)
        
        # åˆ›å»ºç”˜ç‰¹å›¾
        fig = ff.create_gantt(
            df,
            colors={
                'Legal': 'rgb(220, 0, 0)',
                'Consultant': 'rgb(170, 14, 200)',
                'Council': 'rgb(255, 140, 0)',
                'Architect': 'rgb(46, 137, 205)',
                'Procurement': 'rgb(114, 44, 121)',
                'Builder': 'rgb(198, 47, 105)',
                'Marketing': 'rgb(58, 149, 136)',
            },
            index_col='Resource',
            show_colorbar=True,
            group_tasks=True,
            showgrid_x=True,
            showgrid_y=True,
            title=f"{selected_project} - é¡¹ç›®æ—¶é—´è½´"
        )
        
        fig.update_layout(
            height=600,
            xaxis_title="æ—¶é—´è½´",
            yaxis_title="ä»»åŠ¡é˜¶æ®µ",
            hovermode='closest'
        )
        
        st.plotly_chart(fig, use_container_width=True)
        
        # What-if åˆ†æ
        st.subheader("ğŸ”® What-if æƒ…æ™¯åˆ†æ")
        
        col1, col2 = st.columns(2)
        
        with col1:
            delay_task = st.selectbox(
                "å¦‚æœå“ªä¸ªä»»åŠ¡å»¶è¿Ÿ?",
                [s['Task'] for s in stages]
            )
            
            delay_days = st.slider(
                "å»¶è¿Ÿå¤šå°‘å¤©?",
                0, 90, 0
            )
        
        with col2:
            if delay_days > 0:
                # ç®€åŒ–è®¡ç®—ï¼šå‡è®¾åç»­ä»»åŠ¡åŒæ­¥å»¶è¿Ÿ
                original_completion = pd.to_datetime(project["expected_completion"])
                new_completion = original_completion + timedelta(days=delay_days)
                
                st.warning(f"âš ï¸ å»¶è¿Ÿå½±å“åˆ†æ")
                st.metric(
                    "æ–°çš„å®Œå·¥æ—¥æœŸ",
                    new_completion.strftime("%Y-%m-%d"),
                    delta=f"+{delay_days} å¤©",
                    delta_color="inverse"
                )
                
                # è®¡ç®—é¢å¤–æˆæœ¬ï¼ˆå‡è®¾æ¯å¤©$1000ï¼‰
                extra_cost = delay_days * 1000
                st.metric(
                    "é¢„è®¡é¢å¤–æˆæœ¬",
                    f"${extra_cost:,}",
                    delta=f"+${extra_cost:,}"
                )
    
    else:
        st.info("ğŸ“ è¿˜æ²¡æœ‰é¡¹ç›®æ•°æ®ï¼Œè¯·å…ˆåœ¨Data Input Centeræ·»åŠ é¡¹ç›®")

# ========== å¤šé¡¹ç›®æ€»è§ˆ ==========
elif view_mode == "å¤šé¡¹ç›®æ€»è§ˆ":
    
    st.subheader("ğŸ—“ï¸ æ‰€æœ‰æ´»è·ƒé¡¹ç›®æ—¶é—´è½´")
    
    projects_df = get_projects_from_db()
    
    if not projects_df.empty:
        # åˆ›å»ºæ—¶é—´è½´æ•°æ®
        timeline_data = []
        
        for idx, row in projects_df.iterrows():
            timeline_data.append({
                'Task': f"{row['asset_name']} - {row['project_name']}",
                'Start': row['start_date'],
                'Finish': row['expected_completion'],
                'Completion': row['completion_percentage']
            })
        
        df = pd.DataFrame(timeline_data)
        
        # åˆ›å»ºæ¨ªå‘æ—¶é—´è½´
        fig = px.timeline(
            df,
            x_start="Start",
            x_end="Finish",
            y="Task",
            color="Completion",
            title="æ‰€æœ‰é¡¹ç›®æ—¶é—´è½´æ€»è§ˆ",
            color_continuous_scale="RdYlGn"
        )
        
        fig.update_yaxes(autorange="reversed")
        fig.update_layout(height=max(400, len(df) * 60))
        
        st.plotly_chart(fig, use_container_width=True)
        
        # ç»Ÿè®¡ä¿¡æ¯
        col1, col2, col3 = st.columns(3)
        
        with col1:
            st.metric("æ´»è·ƒé¡¹ç›®", len(projects_df))
        
        with col2:
            avg_completion = projects_df['completion_percentage'].mean()
            st.metric("å¹³å‡è¿›åº¦", f"{avg_completion:.1f}%")
        
        with col3:
            # è®¡ç®—æœ¬å­£åº¦å°†å®Œæˆçš„é¡¹ç›®
            this_quarter_end = pd.Timestamp.now() + pd.DateOffset(months=3)
            completing_soon = projects_df[
                pd.to_datetime(projects_df['expected_completion']) < this_quarter_end
            ]
            st.metric("æœ¬å­£åº¦å®Œå·¥", len(completing_soon))
        
        # é‡Œç¨‹ç¢‘æé†’
        st.subheader("ğŸ“Œ å³å°†åˆ°æ¥çš„é‡Œç¨‹ç¢‘")
        
        next_30_days = pd.Timestamp.now() + pd.DateOffset(days=30)
        upcoming = projects_df[
            pd.to_datetime(projects_df['expected_completion']) < next_30_days
        ]
        
        if not upcoming.empty:
            for idx, proj in upcoming.iterrows():
                days_left = (
                    pd.to_datetime(proj['expected_completion']) - pd.Timestamp.now()
                ).days
                
                st.info(
                    f"ğŸ”” **{proj['project_name']}** - "
                    f"{proj['status']} é˜¶æ®µå°†åœ¨ {days_left} å¤©åå®Œæˆ "
                    f"({proj['expected_completion']})"
                )
        else:
            st.success("âœ… æœªæ¥30å¤©å†…æ²¡æœ‰å³å°†åˆ°æœŸçš„é‡Œç¨‹ç¢‘")
    
    else:
        st.info("ğŸ“ è¿˜æ²¡æœ‰é¡¹ç›®æ•°æ®")

# ========== åˆ›å»ºæ–°æ—¶é—´è½´ ==========
else:  # åˆ›å»ºæ–°æ—¶é—´è½´
    
    st.subheader("â• åˆ›å»ºæ–°çš„é¡¹ç›®æ—¶é—´è½´")
    
    # æ–¹å¼1: è‡ªç„¶è¯­è¨€è¾“å…¥
    with st.expander("ğŸ“ æ–¹å¼1: è‡ªç„¶è¯­è¨€è¾“å…¥ (æ¨è)", expanded=True):
        st.write("ç”¨ç®€å•çš„è¯­è¨€æè¿°é¡¹ç›®é˜¶æ®µï¼ŒAIä¼šè‡ªåŠ¨è§£æ")
        
        text_input = st.text_area(
            "æè¿°é¡¹ç›®é˜¶æ®µ:",
            value="""- DA submission 2å‘¨ï¼Œç°åœ¨å¼€å§‹
- Council approval ç­‰å¾…8å‘¨ï¼ŒDAå®Œæˆåå¼€å§‹
- è¯¦ç»†è®¾è®¡4å‘¨ï¼Œapprovalåå¼€å§‹
- Tendering 3å‘¨
- Construction 26å‘¨""",
            height=150
        )
        
        if st.button("ğŸ¤– AIè§£æå¹¶ç”Ÿæˆç”˜ç‰¹å›¾"):
            # è¿™é‡Œå¯ä»¥è°ƒç”¨Claude APIåšæ™ºèƒ½è§£æ
            st.info("ğŸ’¡ æç¤º: è¿™ä¸ªåŠŸèƒ½éœ€è¦é›†æˆClaude API")
            
            # ç®€å•æ¼”ç¤º
            with st.spinner("AIæ­£åœ¨è§£æ..."):
                import time
                time.sleep(2)
                st.success("âœ… è§£æå®Œæˆï¼å·²ç”Ÿæˆ5ä¸ªä»»åŠ¡")
    
    # æ–¹å¼2: æ‰‹åŠ¨è¾“å…¥
    with st.expander("âœï¸ æ–¹å¼2: æ‰‹åŠ¨è¾“å…¥è¡¨æ ¼"):
        st.write("é€è¡Œæ·»åŠ ä»»åŠ¡")
        
        # ä½¿ç”¨ st.data_editor è®©ç”¨æˆ·ç¼–è¾‘è¡¨æ ¼
        sample_data = pd.DataFrame({
            'ä»»åŠ¡åç§°': ['DA Submission', 'Council Approval'],
            'æŒç»­æ—¶é—´(å¤©)': [14, 56],
            'å¼€å§‹æ—¥æœŸ': ['2024-06-01', '2024-06-15'],
            'ä¾èµ–ä»»åŠ¡': ['', 'DA Submission'],
        })
        
        edited_df = st.data_editor(
            sample_data,
            num_rows="dynamic",
            use_container_width=True
        )
        
        if st.button("ç”Ÿæˆç”˜ç‰¹å›¾"):
            st.success("âœ… ç”˜ç‰¹å›¾å·²ç”Ÿæˆ")

# ========== ä¾§è¾¹æ : è®¾ç½® ==========
with st.sidebar:
    st.header("âš™ï¸ è®¾ç½®")
    
    # å·¥ä½œæ—¥è®¾ç½®
    st.subheader("å·¥ä½œæ—¥è®¾ç½®")
    work_days = st.multiselect(
        "å·¥ä½œæ—¥:",
        ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'],
        default=['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”']
    )
    
    # å…¬å…±å‡æœŸ
    st.subheader("å…¬å…±å‡æœŸ")
    holidays = st.text_area(
        "è¾“å…¥å‡æœŸæ—¥æœŸ (ä¸€è¡Œä¸€ä¸ª):",
        value="2024-12-25\n2024-12-26\n2025-01-01"
    )
    
    # å¯¼å‡ºé€‰é¡¹
    st.subheader("å¯¼å‡º")
    if st.button("ğŸ“¥ å¯¼å‡ºä¸ºExcel"):
        st.info("å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...")
    
    if st.button("ğŸ“¥ å¯¼å‡ºä¸ºPDF"):
        st.info("å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...")
